<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Assassins â€” Daily Brief</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b0f13">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="AIA Brief">
<link rel="apple-touch-icon" href="./icon-180.png">
<style>
:root{--bg:#0b0f13;--muted:#96a0ad;--text:#e8edf3;--border:#223041;--card:#0f141b;--brand:#8ab4f8}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:#0b0f13f0;border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px)}
.wrap{max-width:1100px;margin:auto;padding:16px}
.row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
button{background:#1a2330;border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:10px}
button:hover{border-color:#2f4159}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(270px,1fr));gap:14px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
.kvs{display:grid;grid-template-columns:1fr auto;gap:6px;font-variant-numeric:tabular-nums}
.badge{font-size:11px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
ul{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px}
li{line-height:1.35}
a{color:var(--brand);text-decoration:none}
a:hover{text-decoration:underline}
.checkbox{display:flex;gap:10px;align-items:flex-start}
.small{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="./icon-180.png" alt="AI Assassins logo" width="44" height="44" style="border-radius:10px;box-shadow:0 0 0 1px var(--border)">
        <div>
          <h1 style="margin:0;font-size:18px">AI Assassins â€” Daily Brief</h1>
          <div id="subtitle" class="small"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="generate">Generate Brief</button>
        <button id="save">Save</button>
        <button id="export">Export</button>
        <button id="print">Print</button>
        <button id="openSettings">Settings</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="brief" class="grid" aria-live="polite"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:24px">
    <h2>Saved Briefs</h2><span class="badge" id="saveCount">0 saved</span>
  </div>
  <div id="saved" class="grid"></div>
</main>

<dialog id="settingsDialog">
  <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
    <strong>Brief Settings</strong><button id="closeSettings">âœ•</button>
  </div>
  <div style="padding:16px" class="grid" id="settingsGrid"></div>
  <div style="display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--border)">
    <button id="reset">Reset</button><button id="saveSettings">Save Settings</button>
  </div>
</dialog>

<script type="module" src="./integrations.js"></script>
<script>
// Utils
const $=s=>document.querySelector(s); const now=()=>new Date().toLocaleString(undefined,{dateStyle:'full',timeStyle:'short'});
const defaults={callsign:'Colonel',briefTime:'07:00',eveningTime:'19:00',focus:'geopolitics, defense, cyber, space, markets, weather',scripturePref:'kjv',priorities:'- ARCHAIOS Vault\n- QX AI Chip\n- Nanotech Dossier\n- Sermon Series\n- Saint Black OS',closing:'Honor. Discipline. Mercy. â€” ARCHAIOS Sentinel',latlon:'',newsApiKey:'',icsUrl:'',agendaCount:3};
const load=()=>Object.assign({},defaults,JSON.parse(localStorage.getItem('aia_settings_v9')||'null')||{});
const save=s=>localStorage.setItem('aia_settings_v9',JSON.stringify(s));
const esc=s=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const isAnchor=s=>typeof s==='string' && /^\s*<a\s/i.test(s);

// Brief template
function tpl(){const s=load();const d=new Date();return{id:Date.now(),title:`Daily SitRep â€” ${d.toLocaleDateString()}`,generatedAt:d.toISOString(),sections:[
  {key:'overview',title:'ðŸ›°ï¸ Overnight Overview',items:[]},
  {key:'markets',title:'ðŸ“ˆ Markets Snapshot',kvs:[['S&P 500','â€”'],['Nasdaq','â€”'],['WTI','â€”'],['BTC','â€”']],note:'Autoâ€‘filled; tap Generate'},
  {key:'weather',title:'â›… Weather (Local)',items:[],note:'Set lat,lon in Settings'},
  {key:'calendar',title:'ðŸ—“ï¸ Next Up (Calendar)',items:['(Add ICS link in Settings)'],note:'CORS must allow fetch'},
  {key:'scripture',title:'ðŸ“– Scripture of the Day',items:[]},
  {key:'priorities',title:'ðŸŽ¯ Mission Priorities',items:s.priorities.split('\n').filter(Boolean).map(x=>x.replace(/^\-\s*/,''))},
  {key:'truthwave',title:'ðŸœ Black Phoenix Truthwave',items:['Top narrative/meme: â€”','Risk flag: â€”','Counterâ€‘PSYOP: â€”']},
  {key:'tasks',title:'âœ… Top 5 Tasks',items:['â€”','â€”','â€”','â€”','â€”']},
  {key:'closing',title:'âš”ï¸ Command Note',items:[`${s.callsign}, stay sharp. ${s.closing}`]}
]};}

function domIdForMarket(label){
  if(label==='S&P 500') return 'sp500';
  if(label==='Nasdaq') return 'nasdaq';
  if(label==='WTI') return 'wti';
  if(label==='BTC') return 'btc';
  return '';
}
function domIdForSection(key){
  if(key==='overview') return 'overnightOverview';
  if(key==='weather') return 'weatherLocal';
  if(key==='calendar') return 'calendarEvents';
  if(key==='scripture') return 'scriptureDay';
  if(key==='priorities') return 'missionPriorities';
  if(key==='truthwave') return 'truthwave';
  if(key==='tasks') return 'topTasks';
  return '';
}
// Renderer
function render(b){const root=$('#brief');root.innerHTML='';b.sections.forEach(s=>{const sec=document.createElement('section');sec.className='card';sec.innerHTML=`<div style='display:flex;justify-content:space-between;align-items:center'><h3 style='margin:.2rem 0 .6rem 0'>${s.title}</h3>${s.note?`<span class='badge'>${s.note}</span>`:''}</div><div class='body'></div>`;const body=sec.querySelector('.body');if(s.kvs){const kv=document.createElement('div');kv.className='kvs';s.kvs.forEach(([k,v])=>{const a=document.createElement('div');a.textContent=k;const d=document.createElement('div');const id=domIdForMarket(k);if(id)d.id=id;d.innerHTML=(v==='â€”')?'<span class="small">â€”</span>':esc(v);kv.appendChild(a);kv.appendChild(d)});body.appendChild(kv)}else{const ul=document.createElement('ul');const sid=domIdForSection(s.key);if(sid)ul.id=sid;if(s.key==='closing'){const li=document.createElement('li');li.id='commandNote';const text=(s.items&&s.items[0])?s.items[0]:'â€”';li.innerHTML=esc(text);ul.appendChild(li)}else{s.items.forEach(it=>{const li=document.createElement('li');if(isAnchor(it)){li.innerHTML=it}else if(typeof it==='string'){li.innerHTML=esc(it)}else{li.textContent=String(it)}ul.appendChild(li)})}body.appendChild(ul)}root.appendChild(sec)});}

// Saved briefs
function saveBrief(b){const all=JSON.parse(localStorage.getItem('aia_briefs_v9')||'[]');all.unshift(b);localStorage.setItem('aia_briefs_v9',JSON.stringify(all));$('#saveCount').textContent=`${all.length} saved`;}
function showSaved(){const all=JSON.parse(localStorage.getItem('aia_briefs_v9')||'[]');$('#saveCount').textContent=`${all.length} saved`;const slot=$('#saved');slot.innerHTML='';all.forEach(b=>{const when=new Date(b.generatedAt).toLocaleString(undefined,{dateStyle:'medium',timeStyle:'short'});const card=document.createElement('div');card.className='card';card.innerHTML=`<div style='display:flex;justify-content:space-between;align-items:center'><strong>${b.title}</strong><span class='badge'>${when}</span></div>`;slot.appendChild(card)});}

// Settings UI
function settingsUI(){const s=load();const g=$('#settingsGrid');g.innerHTML='';g.style.display='grid';g.style.gridTemplateColumns='1fr 1fr';g.style.gap='10px';
g.insertAdjacentHTML('beforeend',`<label>Callsign<br><input id='callsign' value='${s.callsign}'></label>`);
g.insertAdjacentHTML('beforeend',`<label>Morning Time<br><input id='briefTime' type='time' value='${s.briefTime}'></label>`);
g.insertAdjacentHTML('beforeend',`<label>Evening Time<br><input id='eveningTime' type='time' value='${s.eveningTime}'></label>`);
g.insertAdjacentHTML('beforeend',`<label>Focus<br><input id='focus' value='${s.focus}'></label>`);
g.insertAdjacentHTML('beforeend',`<label>Scripture<br><select id='scripturePref'><option value='kjv' ${s.scripturePref==='kjv'?'selected':''}>KJV</option><option value='niv' ${s.scripturePref==='niv'?'selected':''}>NIV</option><option value='esv' ${s.scripturePref==='esv'?'selected':''}>ESV</option></select></label>`);
g.insertAdjacentHTML('beforeend',`<label>Openâ€‘Meteo (lat,lon)<br><input id='latlon' placeholder='29.7604,-95.3698' value='${s.latlon}'></label>`);
g.insertAdjacentHTML('beforeend',`<label>NewsAPI key (optional)<br><input id='newsApiKey' placeholder='paste key' value='${s.newsApiKey}'></label>`);
g.insertAdjacentHTML('beforeend',`<label>Calendar ICS URL<br><input id='icsUrl' placeholder='https://.../calendar.ics' value='${s.icsUrl}'></label>`);
g.insertAdjacentHTML('beforeend',`<label>Agenda items to show<br><input id='agendaCount' type='number' min='1' max='10' value='${s.agendaCount}'></label>`);
g.insertAdjacentHTML('beforeend',`<label>Standing Priorities<br><textarea id='priorities' rows='6'>${s.priorities}</textarea></label>`);
}

document.addEventListener('DOMContentLoaded', async ()=>{
  $('#subtitle').textContent=now(); let b=tpl(); render(b); showSaved();
  try{ b=await window.AIA.fillLive(b, load()); render(b);}catch{}
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
  $('#generate').onclick=async()=>{let d=tpl(); render(d); try{ d=await window.AIA.fillLive(d, load()); }catch{} try{ d=await window.AIA.generateBrief(d, load()); }catch{} b=d; render(b);};
  $('#save').onclick=()=>saveBrief(b);
  $('#export').onclick=()=>{const data={settings:load(),briefs:JSON.parse(localStorage.getItem('aia_briefs_v9')||'[]')}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ai-assassins-brief-export.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);};
  $('#print').onclick=()=>window.print();
  const dlg=$('#settingsDialog'); $('#openSettings').onclick=()=>{settingsUI(); dlg.showModal();}; $('#closeSettings').onclick=()=>dlg.close();
  $('#reset').onclick=()=>{localStorage.removeItem('aia_settings_v9'); settingsUI();};
  $('#saveSettings').onclick=()=>{const s={callsign:document.querySelector('#callsign').value.trim()||'Colonel',briefTime:document.querySelector('#briefTime').value||'07:00',eveningTime:document.querySelector('#eveningTime').value||'19:00',focus:document.querySelector('#focus').value.trim(),scripturePref:document.querySelector('#scripturePref').value,priorities:document.querySelector('#priorities').value,latlon:document.querySelector('#latlon').value.trim(),newsApiKey:document.querySelector('#newsApiKey').value.trim(),icsUrl:document.querySelector('#icsUrl').value.trim(),agendaCount:parseInt(document.querySelector('#agendaCount').value)||3}; save(s); dlg.close();};
});
</script>
</body>
</html>
