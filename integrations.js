window.AIA=(()=>{const f=async(b,s)=>{await Promise.allSettled([w(b,s),m(b),t(b),v(b,s),n(b,s)]);return b;};function sec(b,k){return b.sections.find(x=>x.key===k);}async function w(b,s){if(!s.latlon)return;const a=s.latlon.split(',').map(x=>parseFloat(x.trim()));if(a.some(isNaN))return;const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${a[0]}&longitude=${a[1]}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&forecast_days=1&timezone=auto`);if(!r.ok)return;const j=await r.json();const S=sec(b,'weather');S.items=[`High / Low: ${j.daily?.temperature_2m_max?.[0]??'—'}° / ${j.daily?.temperature_2m_min?.[0]??'—'}°`,`Precip: ${j.daily?.precipitation_sum?.[0]??'—'} mm`];}async function t(b){const r=await fetch('https://api.coindesk.com/v1/bpi/currentprice.json').catch(()=>null);if(!r||!r.ok)return;const j=await r.json();const usd=j?.bpi?.USD?.rate_float;if(!usd)return;const M=sec(b,'markets');if(!M?.kvs)return;for(const row of M.kvs){if(row[0]==='BTC'){row[1]='$'+usd.toLocaleString(undefined,{maximumFractionDigits:0});}}}async function m(b){const sy=encodeURIComponent('^GSPC,^IXIC,CL=F');const r=await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${sy}`).catch(()=>null);if(!r||!r.ok)return;const j=await r.json();const map={};for(const q of j.quoteResponse.result){map[q.symbol]=q;}const M=sec(b,'markets');if(!M?.kvs)return;const rows={'S&P 500':map['^GSPC'],'Nasdaq':map['^IXIC'],'WTI':map['CL=F']};M.kvs=Object.entries(rows).map(([n,q])=>q?[n,`${q.regularMarketPrice?.toFixed(2)} (${(q.regularMarketChangePercent??0).toFixed(2)}%)`]:[n,'—']).concat(M.kvs.find(r=>r[0]==='BTC')?[]:[['BTC','—']]);}async function v(b,s){const verses={kjv:[['Psalm 27:1','The LORD is my light and my salvation; whom shall I fear?'],['Isaiah 41:10','Fear thou not; for I am with thee...'],['John 14:27','Peace I leave with you, my peace I give unto you...']],niv:[['Psalm 27:1','The LORD is my light and my salvation— whom shall I fear?'],['Isaiah 41:10','So do not fear, for I am with you...'],['John 14:27','Peace I leave with you; my peace I give you...']],esv:[['Psalm 27:1','The LORD is my light and my salvation; whom shall I fear?'],['Isaiah 41:10','Fear not, for I am with you...'],['John 14:27','Peace I leave with you; my peace I give to you...']]};const pref=(s.scripturePref||'kjv').toLowerCase();const arr=verses[pref]||verses.kjv;const [ref,text]=arr[(new Date()).getDate()%arr.length];const S=sec(b,'scripture');S.items=[pref.toUpperCase()+' — '+ref,text,'Reflection: Christ steadies the mission; courage under pressure.'];}async function n(b,s){const S=sec(b,'overview');if(!S)return;try{if(s.newsApiKey){const q=encodeURIComponent('geopolitics OR defense OR cyber OR space OR infrastructure');const u=`https://newsapi.org/v2/top-headlines?language=en&pageSize=6&q=${q}`;const r=await fetch(u,{headers:{'X-Api-Key':s.newsApiKey}});if(r.ok){const j=await r.json();S.items=(j.articles||[]).slice(0,6).map(a=>`<a class="a" href="${a.url}" target="_blank" rel="noopener">${a.title}</a>`);return;}}const feeds=['https://feeds.bbci.co.uk/news/world/rss.xml','https://www.defense.gov/Newsroom/News/RSS/','https://www.nasa.gov/news-release/feed/'];const rs=await Promise.allSettled(feeds.map(f=>fetch('https://api.rss2json.com/v1/api.json?rss_url='+encodeURIComponent(f))));const items=[];for(const r of rs){if(r.status==='fulfilled'&&r.value.ok){const j=await r.value.json();for(const it of (j.items||[]).slice(0,2)){items.push(`<a class="a" href="${it.link}" target="_blank" rel="noopener">${it.title}</a>`);}}}S.items=items.length?items:['(Add a NewsAPI key in Settings for richer headlines)'];}catch{}}return{fillLive:f};})();