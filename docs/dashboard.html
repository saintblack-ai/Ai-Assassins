<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ARCHAIOS CONTROL CENTER</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            abyss: "#05080a",
            panel: "#0b1114",
            neon: "#6dff7a",
            neonSoft: "#1f9f3d",
            muted: "#95a59c"
          },
          boxShadow: {
            neon: "0 0 0 1px rgba(109,255,122,.35), 0 0 26px rgba(109,255,122,.15)"
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-abyss text-slate-100">
  <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
    <header class="mb-6 rounded-xl border border-neonSoft/40 bg-panel/90 p-5 shadow-neon">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-xl font-semibold tracking-[0.22em] text-neon">ARCHAIOS CONTROL CENTER</h1>
          <p class="mt-1 text-sm text-muted">Saint Black Intelligence System</p>
        </div>
        <div class="flex items-center gap-3">
          <span class="text-xs uppercase tracking-[0.2em] text-muted">Current Tier</span>
          <span id="tierBadge" class="rounded-full border border-neonSoft/60 bg-neonSoft/15 px-3 py-1 text-xs font-medium text-neon">Loading...</span>
        </div>
      </div>
    </header>

    <section class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4">
      <article class="rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
        <p class="text-xs uppercase tracking-[0.18em] text-muted">Current Tier</p>
        <p id="statTier" class="mt-2 text-2xl font-semibold text-neon">-</p>
      </article>
      <article class="rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
        <p class="text-xs uppercase tracking-[0.18em] text-muted">Daily Usage</p>
        <p id="statUsage" class="mt-2 text-2xl font-semibold text-neon">-</p>
      </article>
      <article class="rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
        <p class="text-xs uppercase tracking-[0.18em] text-muted">Revenue (USD)</p>
        <p id="statRevenue" class="mt-2 text-2xl font-semibold text-neon">-</p>
      </article>
      <article class="rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
        <p class="text-xs uppercase tracking-[0.18em] text-muted">Subscriptions</p>
        <p id="statSubscriptions" class="mt-2 text-2xl font-semibold text-neon">-</p>
      </article>
    </section>

    <section class="mt-6 rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
      <h2 class="text-sm uppercase tracking-[0.2em] text-neon">Revenue Fortress</h2>
      <div class="mt-3 grid grid-cols-1 gap-3 lg:grid-cols-2">
        <div class="rounded-lg border border-neonSoft/25 bg-black/35 p-3">
          <p class="text-xs uppercase tracking-[0.16em] text-muted">API Status</p>
          <p id="apiStatusText" class="mt-2 text-sm text-slate-100">Checking...</p>
          <p id="apiStatusMeta" class="mt-1 text-xs text-muted">-</p>
        </div>
        <div class="rounded-lg border border-neonSoft/25 bg-black/35 p-3">
          <p class="text-xs uppercase tracking-[0.16em] text-muted">Latest Revenue Brief</p>
          <pre id="latestBriefBox" class="mt-2 max-h-40 overflow-auto text-xs text-green-100">Loading...</pre>
        </div>
      </div>
      <div class="mt-3 grid grid-cols-1 gap-3 lg:grid-cols-2">
        <div class="rounded-lg border border-neonSoft/25 bg-black/35 p-3">
          <p class="text-xs uppercase tracking-[0.16em] text-muted">Upgrade</p>
          <div class="mt-2 flex flex-wrap gap-2">
            <button id="btnRfPro" class="rounded-md border border-neonSoft/60 bg-neonSoft/20 px-3 py-2 text-sm font-medium text-neon">Go Pro</button>
            <button id="btnRfElite" class="rounded-md border border-neonSoft/60 bg-neonSoft/20 px-3 py-2 text-sm font-medium text-neon">Go Elite</button>
            <button id="btnRfEnterprise" class="rounded-md border border-neonSoft/60 bg-neonSoft/20 px-3 py-2 text-sm font-medium text-neon">Go Enterprise</button>
          </div>
        </div>
        <div class="rounded-lg border border-neonSoft/25 bg-black/35 p-3">
          <p class="text-xs uppercase tracking-[0.16em] text-muted">Enterprise Lead Capture</p>
          <div class="mt-2 grid grid-cols-1 gap-2">
            <input id="leadName" class="rounded border border-neonSoft/35 bg-panel px-2 py-1 text-sm" placeholder="Name">
            <input id="leadEmail" class="rounded border border-neonSoft/35 bg-panel px-2 py-1 text-sm" placeholder="Email">
            <input id="leadOrg" class="rounded border border-neonSoft/35 bg-panel px-2 py-1 text-sm" placeholder="Organization">
            <textarea id="leadMessage" class="rounded border border-neonSoft/35 bg-panel px-2 py-1 text-sm" rows="2" placeholder="Message"></textarea>
            <button id="btnSubmitLead" class="rounded-md border border-neonSoft/60 bg-neonSoft/20 px-3 py-2 text-sm font-medium text-neon">Submit Lead</button>
          </div>
        </div>
      </div>
    </section>

    <section class="mt-6 grid grid-cols-1 gap-4 xl:grid-cols-3">
      <article class="xl:col-span-2 rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-sm uppercase tracking-[0.2em] text-neon">Command Center</h2>
          <div class="flex gap-2">
            <button id="btnCommander0700" class="rounded-md border border-neonSoft/60 bg-neonSoft/20 px-3 py-2 text-sm font-medium text-neon transition hover:bg-neonSoft/30">Commander Brief 0700</button>
            <button id="btnGenerateBrief" class="rounded-md border border-neonSoft/60 bg-neonSoft/20 px-3 py-2 text-sm font-medium text-neon transition hover:bg-neonSoft/30">Generate Brief</button>
          </div>
        </div>
        <p id="briefStatus" class="mt-3 text-xs text-muted">Ready</p>
        <pre id="terminalBox" class="mt-3 h-[26rem] overflow-auto rounded-lg border border-neonSoft/30 bg-black/50 p-3 text-xs leading-relaxed text-green-200">Awaiting command...</pre>
      </article>

      <article class="rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
        <h2 class="text-sm uppercase tracking-[0.2em] text-neon">Daily Brief Viewer</h2>
        <p id="dailyBriefMeta" class="mt-3 text-xs text-muted">Loading latest brief...</p>
        <pre id="dailyBriefBox" class="mt-3 h-[26rem] overflow-auto rounded-lg border border-neonSoft/30 bg-black/45 p-3 text-xs leading-relaxed text-green-100">Loading...</pre>
      </article>
    </section>

    <section class="mt-6 rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
      <h2 class="text-sm uppercase tracking-[0.2em] text-neon">Commander Daily 0700</h2>
      <div id="commanderCard" class="mt-3 grid grid-cols-1 gap-2 text-sm text-slate-200 sm:grid-cols-2">
        <div><span class="text-muted">Date:</span> <span id="cmdDate">-</span></div>
        <div><span class="text-muted">Mission:</span> <span id="cmdMission">-</span></div>
        <div><span class="text-muted">Revenue:</span> <span id="cmdRevenue">-</span></div>
        <div><span class="text-muted">Brand Growth:</span> <span id="cmdBrand">-</span></div>
        <div><span class="text-muted">Premium Lock:</span> <span id="cmdPremiumLock">-</span></div>
        <div class="sm:col-span-2"><span class="text-muted">Priority 1:</span> <span id="cmdP1">-</span></div>
        <div class="sm:col-span-2"><span class="text-muted">Priority 2:</span> <span id="cmdP2">-</span></div>
        <div class="sm:col-span-2"><span class="text-muted">Priority 3:</span> <span id="cmdP3">-</span></div>
      </div>
    </section>

    <section class="mt-6 rounded-xl border border-neonSoft/30 bg-panel p-4 shadow-neon">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-sm uppercase tracking-[0.2em] text-neon">Enterprise Upgrade</h2>
          <p class="mt-1 text-sm text-muted">Activate Pro/Elite workflows and enterprise support paths.</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="btnUpgradePro" class="inline-flex items-center rounded-md border border-neonSoft/60 bg-neonSoft/20 px-4 py-2 text-sm font-medium text-neon transition hover:bg-neonSoft/30">Upgrade to Pro</button>
          <button id="btnUpgradeElite" class="inline-flex items-center rounded-md border border-neonSoft/60 bg-neonSoft/20 px-4 py-2 text-sm font-medium text-neon transition hover:bg-neonSoft/30">Upgrade to Elite</button>
          <a href="./pricing.html" class="inline-flex items-center rounded-md border border-neonSoft/60 bg-neonSoft/20 px-4 py-2 text-sm font-medium text-neon transition hover:bg-neonSoft/30">Pricing</a>
        </div>
      </div>
    </section>

    <div id="dashboardError" class="mt-4 hidden rounded-lg border border-red-500/40 bg-red-900/20 p-3 text-sm text-red-200"></div>
  </div>

  <script>
    (() => {
      "use strict";

      const API_BASE = "https://ai-assassins-api.quandrix357.workers.dev";

      const byId = (id) => {
        const el = document.getElementById(id);
        if (!el) console.warn(`[Dashboard] Missing element #${id}`);
        return el;
      };

      const setText = (id, value) => {
        const el = byId(id);
        if (el) el.textContent = value;
      };

      const setError = (message) => {
        const el = byId("dashboardError");
        if (!el) return;
        if (message) {
          el.classList.remove("hidden");
          el.textContent = message;
        } else {
          el.classList.add("hidden");
          el.textContent = "";
        }
      };

      async function fetchJson(path, init = {}) {
        const url = `${API_BASE}${path}`;
        const response = await fetch(url, {
          ...init,
          headers: {
            Accept: "application/json",
            ...(init.headers || {})
          }
        });

        const text = await response.text();
        let data;
        try {
          data = text ? JSON.parse(text) : {};
        } catch {
          throw new Error(`Invalid JSON from ${path}`);
        }

        if (!response.ok) {
          const msg = data?.error || `Request failed (${response.status})`;
          throw new Error(msg);
        }

        return data;
      }

      function pretty(value) {
        return JSON.stringify(value, null, 2);
      }

      async function loadStats() {
        try {
          const [me, metrics, revenue] = await Promise.all([
            fetchJson("/api/me"),
            fetchJson("/api/metrics"),
            fetchJson("/api/revenue-summary")
          ]);

          const tier = String(me?.tier || "free").toUpperCase();
          const usage = me?.usage_today ?? 0;
          const usageLimit = me?.usage_limit === null ? "âˆž" : (me?.usage_limit ?? "-");
          const totalRevenue = revenue?.total_revenue ?? 0;
          const totalSubscriptions = revenue?.total_subscriptions ?? 0;

          setText("tierBadge", tier);
          setText("statTier", tier);
          setText("statUsage", `${usage} / ${usageLimit}`);
          setText("statRevenue", `$${Number(totalRevenue).toLocaleString(undefined, { maximumFractionDigits: 2 })}`);
          setText("statSubscriptions", String(totalSubscriptions));
          setError("");
        } catch (error) {
          console.error("[Dashboard] stats error", error);
          setText("tierBadge", "UNAVAILABLE");
          setText("statTier", "N/A");
          setText("statUsage", "N/A");
          setText("statRevenue", "N/A");
          setText("statSubscriptions", "N/A");
          setError("Unable to load dashboard stats.");
        }
      }

      async function loadApiStatus() {
        try {
          const status = await fetchJson("/api/status");
          setText("apiStatusText", status?.success ? "Operational" : "Degraded");
          setText("apiStatusMeta", `version=${status?.version || "-"} schedule=${status?.schedule || "-"}`);
        } catch (error) {
          console.error("[Dashboard] api status error", error);
          setText("apiStatusText", "Unavailable");
          setText("apiStatusMeta", "status endpoint unreachable");
        }
      }

      async function loadLatestRevenueBrief() {
        try {
          const payload = await fetchJson("/api/brief/latest");
          const box = byId("latestBriefBox");
          if (box) box.textContent = pretty(payload);
        } catch (error) {
          console.error("[Dashboard] latest brief error", error);
          const box = byId("latestBriefBox");
          if (box) box.textContent = "Unavailable";
        }
      }

      async function loadDailyBrief() {
        const box = byId("dailyBriefBox");
        const meta = byId("dailyBriefMeta");
        if (!box || !meta) return;

        try {
          const payload = await fetchJson("/api/brief/today");
          meta.textContent = payload?.key ? `Source key: ${payload.key}` : "Latest strategic brief";
          box.textContent = pretty(payload?.brief || payload);
        } catch (error) {
          console.error("[Dashboard] daily brief error", error);
          meta.textContent = "Daily brief unavailable";
          box.textContent = "No daily brief available.";
        }
      }

      async function generateBrief() {
        const btn = byId("btnGenerateBrief");
        const status = byId("briefStatus");
        const terminal = byId("terminalBox");
        if (!btn || !status || !terminal) return;

        btn.disabled = true;
        status.textContent = "Generating brief...";
        terminal.textContent = "Dispatching POST /api/brief ...";

        try {
          const payload = {
            lat: null,
            lon: null,
            focus: "command-center",
            tone: "strategic"
          };

          const result = await fetchJson("/api/brief", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          status.textContent = `Brief generated @ ${new Date().toISOString()}`;
          terminal.textContent = pretty(result);
          setError("");
        } catch (error) {
          console.error("[Dashboard] generate brief error", error);
          status.textContent = "Generate failed";
          terminal.textContent = `Error:\n${error.message || String(error)}`;
          setError("Generate Brief failed. Ensure you are authenticated if your API requires auth.");
        } finally {
          btn.disabled = false;
        }
      }

      async function startCheckout(plan) {
        try {
          const btn = byId(plan === "pro" ? "btnUpgradePro" : "btnUpgradeElite");
          if (btn) btn.disabled = true;
          const deviceId = localStorage.getItem("aa_device_id") || crypto.randomUUID();
          localStorage.setItem("aa_device_id", deviceId);

          const res = await fetchJson("/api/checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tier: plan,
              deviceId,
              success_url: `${location.origin}${location.pathname}?checkout=success`,
              cancel_url: `${location.origin}${location.pathname}?checkout=cancel`
            })
          });

          if (res?.url) {
            location.href = res.url;
          } else {
            throw new Error("Checkout URL missing");
          }
        } catch (error) {
          console.error("[Dashboard] checkout error", error);
          setError(`Unable to start ${plan} checkout.`);
        } finally {
          const btn = byId(plan === "pro" ? "btnUpgradePro" : "btnUpgradeElite");
          if (btn) btn.disabled = false;
        }
      }

      async function submitLead() {
        const name = byId("leadName")?.value?.trim();
        const email = byId("leadEmail")?.value?.trim();
        const org = byId("leadOrg")?.value?.trim();
        const message = byId("leadMessage")?.value?.trim();
        if (!name || !email || !org || !message) {
          setError("Please complete all lead fields.");
          return;
        }
        const btn = byId("btnSubmitLead");
        if (btn) btn.disabled = true;
        try {
          await fetchJson("/api/lead", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, org, message }),
          });
          setError("");
          const leadMsg = byId("leadMessage");
          if (leadMsg) leadMsg.value = "";
          setText("apiStatusMeta", "Lead submitted successfully");
        } catch (error) {
          console.error("[Dashboard] lead submit error", error);
          setError("Lead submission failed.");
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      async function loadCommanderDaily() {
        const btn = byId("btnCommander0700");
        if (btn) btn.disabled = true;
        try {
          const payload = await fetchJson("/daily");
          setText("cmdDate", payload?.date || "N/A");
          setText("cmdMission", payload?.mission || "N/A");
          setText("cmdRevenue", payload?.revenue_status || "N/A");
          setText("cmdBrand", payload?.brand_growth || "N/A");
          setText("cmdPremiumLock", payload?.is_premium_locked ? "LOCKED (Pro required)" : "UNLOCKED");
          setText("cmdP1", payload?.priority_1 || "N/A");
          setText("cmdP2", payload?.priority_2 || "N/A");
          setText("cmdP3", payload?.priority_3 || "N/A");
          setError("");
        } catch (error) {
          console.error("[Dashboard] commander daily error", error);
          setText("cmdDate", "N/A");
          setText("cmdMission", "N/A");
          setText("cmdRevenue", "N/A");
          setText("cmdBrand", "N/A");
          setText("cmdPremiumLock", "N/A");
          setText("cmdP1", "N/A");
          setText("cmdP2", "N/A");
          setText("cmdP3", "N/A");
          setError("Commander daily feed unavailable.");
        } finally {
          if (btn) btn.disabled = false;
        }
      }

      function wireEvents() {
        const btn = byId("btnGenerateBrief");
        if (btn) {
          btn.addEventListener("click", generateBrief);
        }
        const commanderBtn = byId("btnCommander0700");
        if (commanderBtn) {
          commanderBtn.addEventListener("click", loadCommanderDaily);
        }
        const btnPro = byId("btnUpgradePro");
        if (btnPro) {
          btnPro.addEventListener("click", () => startCheckout("pro"));
        }
        const btnElite = byId("btnUpgradeElite");
        if (btnElite) {
          btnElite.addEventListener("click", () => startCheckout("elite"));
        }
        const btnRfPro = byId("btnRfPro");
        if (btnRfPro) btnRfPro.addEventListener("click", () => startCheckout("pro"));
        const btnRfElite = byId("btnRfElite");
        if (btnRfElite) btnRfElite.addEventListener("click", () => startCheckout("elite"));
        const btnRfEnterprise = byId("btnRfEnterprise");
        if (btnRfEnterprise) btnRfEnterprise.addEventListener("click", () => startCheckout("enterprise"));
        const btnSubmitLead = byId("btnSubmitLead");
        if (btnSubmitLead) btnSubmitLead.addEventListener("click", submitLead);
      }

      async function init() {
        wireEvents();
        await Promise.all([loadStats(), loadApiStatus(), loadLatestRevenueBrief(), loadDailyBrief(), loadCommanderDaily()]);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
